--LTC Active Policies w/Customer Address

SELECT
EBI_ISSUED_DATA.LINE_OF_INSURANCE as "Line of Insurance",
EBI_ISSUED_DATA.SRC_SYS_PLCY_NBR as "Policy Number",
EBI_ISSUED_DATA.ISSUE_STATE_CODE as "Issue State",
EBI_ISSUED_DATA.OWNER_FIRST_NME as "Owner First Name",
EBI_ISSUED_DATA.OWNER_LAST_NME as "Owner Last Name",
CAST(EBI_ISSUED_DATA.OWNER_DOB as DATE) as "Owner DOB",
--EBI_ISSUED_DATA.OWNER_TAXID as "Owner SSN",
Right(EBI_ISSUED_DATA.OWNER_TAXID,4) as "Owner SSN Last 4",
CUSTOMER_ADDRESS.MAILING_ADDR_LINE_1 as "Mailing Address Line 1",
CUSTOMER_ADDRESS.MAILING_ADDR_LINE_2 as "Mailing Address Line 2",
CUSTOMER_ADDRESS.MAILING_CITY_NAME  as "City Name",
CUSTOMER_ADDRESS.MAILING_STATE_POSTAL_CODE as "State Postal Code",
CUSTOMER_ADDRESS.MAILING_ZIP_CODE  as "ZIP Code",
CUSTOMER_ADDRESS.MAILING_COUNTRY_NAME as "Mailing Country"

FROM AZTEK_EBIS.EBI_ISSUED_DATA EBI_ISSUED_DATA
LEFT JOIN 
(
    SELECT 
      * 
    FROM 
      (
		SELECT 
		C.POLICY_NBR, 
		A.UPDATE_DATE,
		A.[MAILING_ADDR_LINE_1],
		A.[MAILING_ADDR_LINE_2],
		A.[MAILING_CITY_NAME],
		A.[MAILING_STATE_POSTAL_CODE],
		A.[MAILING_ZIP_CODE],
		A.[MAILING_COUNTRY_NAME],
		ROW_NUMBER() OVER
		(
			PARTITION BY C.POLICY_NBR 
			ORDER BY A.UPDATE_DATE DESC
		) RANK 
       
		FROM AZTEK_FRONTROOM.CUSTOMER_DIM AS A 
		LEFT JOIN AZTEK_FRONTROOM.POLICY_CUSTOMER_FACT AS B ON A.CUSTOMER_DIM_ID = B.CUSTOMER_DIM_ID 
		LEFT JOIN AZTEK_FRONTROOM.POLICY_DIM AS C ON B.POLICY_DIM_ID = C.POLICY_DIM_ID 

		--WHERE 
		--DECLINED_DATE IS NOT NULL
		--OR DEATH_DATE IS NOT NULL
		--OR CANCEL_DATE IS NOT NULL
		--POLICY_STATUS_TYPE_CODE  LIKE '%N%'
		--OR POLICY_STATUS_TYPE_CODE  LIKE '%T%'
		--CURRENT_TERMINATION_CODE
		
		WHERE A.MAILING_ADDR_LINE_1 IS NOT NULL 
		AND A.MAILING_ADDR_LINE_1 <> ''
      ) t

    WHERE t.RANK = 1

) AS CUSTOMER_ADDRESS
	ON CUSTOMER_ADDRESS.POLICY_NBR = EBI_ISSUED_DATA.SRC_SYS_PLCY_NBR

WHERE EBI_ISSUED_DATA.LINE_OF_INSURANCE = 'Long Term'-- LTC, this is the only option to select for LTC
AND EBI_ISSUED_DATA.SOURCEFILE = 'FACounts' -- There are two rows, FACount and FAPremium. I just need one to remove duplication
AND CUSTOMER_ADDRESS.MAILING_ADDR_LINE_1 IS NOT NULL
-- AND EBI_ISSUED_DATA.OWNER_DOB IS NOT NULL
-- AND CUSTOMER_ADDRESS.MAILING_COUNTRY_NAME IS NOT NULL

ORDER BY EBI_ISSUED_DATA.SRC_SYS_PLCY_NBR


